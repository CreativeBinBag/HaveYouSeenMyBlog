---
const FORMSPREE_ID = import.meta.env.PUBLIC_FORM_ID;
---

<section class="max-w-2xl mx-auto my-16 px-4">
  <div class="mb-6 flex flex-col items-center">
    <div class="inline-block">
      <h3
        class="typewriter font-pixel text-2xl md:text-3xl text-gba-text dark:text-p-yellow tracking-wide mb-2"
      >
        Start a conversation...
      </h3>
    </div>
    <p
      class="font-serif text-gray-600 dark:text-gray-400 italic text-center max-w-md"
    >
      Feel free to reach out if you find anything interesting (or outrageous)
      here. You can also just say hi.
    </p>
  </div>

  <div
    class="relative bg-white dark:bg-[#2a2a35] p-1 shadow-pixel-md border-2 border-gray-900 dark:border-gray-600"
  >
    <div
      class="absolute -top-3 -right-3 bg-p-pink text-white font-pixel text-xs px-2 py-1 transform rotate-6 shadow-sm border border-red-900/20 z-10"
    >
      PRIORITY MAIL
    </div>

    <form
      id="contact-form"
      action={`https://formspree.io/f/${FORMSPREE_ID}`}
      method="POST"
      class="p-6 md:p-8 flex flex-col gap-6"
    >
      <!-- Identity & Email -->
      <div class="grid md:grid-cols-2 gap-6">
        <div class="flex flex-col">
          <label
            for="name"
            class="font-pixel text-gray-500 dark:text-gray-400 uppercase text-xs mb-1 tracking-widest"
          >
            Identity
          </label>
          <input
            type="text"
            name="name"
            id="name"
            placeholder="Your Name"
            required
            class="bg-transparent border-b-2 border-gray-300 dark:border-gray-600 py-2 font-serif text-lg text-gba-text dark:text-gray-200 focus:border-p-blue dark:focus:border-p-mint focus:outline-none transition-colors placeholder-gray-300 dark:placeholder-gray-700"
          />
        </div>

        <div class="flex flex-col">
          <label
            for="email"
            class="font-pixel text-gray-500 dark:text-gray-400 uppercase text-xs mb-1 tracking-widest"
          >
            Your Email
          </label>
          <input
            type="email"
            name="email"
            id="email"
            placeholder="name@lab.com"
            required
            class="bg-transparent border-b-2 border-gray-300 dark:border-gray-600 py-2 font-serif text-lg text-gba-text dark:text-gray-200 focus:border-p-blue dark:focus:border-p-mint focus:outline-none transition-colors placeholder-gray-300 dark:placeholder-gray-700"
          />
        </div>
      </div>

      <div class="flex flex-col">
        <label
          for="message"
          class="font-pixel text-gray-500 dark:text-gray-400 uppercase text-xs mb-1 tracking-widest"
        >
          Observations
        </label>
        <textarea
          name="message"
          id="message"
          rows="4"
          placeholder="I found a bug in your Hamiltonian simulation..."
          required
          class="bg-gray-50 dark:bg-black/20 border-2 border-gray-200 dark:border-gray-700 p-4 font-serif text-lg text-gba-text dark:text-gray-200 focus:border-p-blue dark:focus:border-p-mint focus:outline-none transition-colors resize-y rounded-sm"
        ></textarea>
      </div>

      <div class="flex justify-end items-center gap-4">
        <p id="form-error" class="hidden text-red-500 font-pixel text-sm"></p>

        <button
          type="submit"
          id="submit-btn"
          class="group relative inline-flex items-center justify-center px-6 py-2 font-pixel text-lg text-white transition-all duration-200 bg-gray-900 dark:bg-p-blue hover:bg-p-pink dark:hover:bg-p-mint focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span class="mr-2" id="btn-icon">✉</span>
          <span id="btn-text">Send Message</span>
          <div
            class="absolute -bottom-1 -right-1 w-full h-full border-r-2 border-b-2 border-black/30 opacity-50 group-hover:translate-x-0.5 group-hover:translate-y-0.5 transition-transform"
          >
          </div>
        </button>
      </div>
    </form>
  </div>

  <div
    id="success-modal"
    class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"
  >
    <div
      class="bg-white dark:bg-gba-dark border-4 border-p-mint shadow-[8px_8px_0px_0px_rgba(0,0,0,0.5)] max-w-md w-full p-6 relative transform scale-95 transition-transform duration-200 opacity-0"
      id="modal-box"
    >
      <div
        class="flex items-center gap-3 mb-4 border-b-2 border-dashed border-gray-300 dark:border-gray-700 pb-2"
      >
        <div class="w-3 h-3 bg-p-mint animate-pulse rounded-full"></div>
        <h4
          class="font-pixel text-xl text-gba-text dark:text-p-mint uppercase tracking-widest"
        >
          Message Sent
        </h4>
      </div>

      <p class="font-serif text-lg text-gray-700 dark:text-gray-300 mb-6">
        Your message has been successfully dispatched through the tubes. I'll
        get back to you as soon as I finish my tea.
      </p>

      <button
        id="close-modal"
        class="w-full py-3 bg-gray-900 dark:bg-p-blue text-white font-pixel text-lg hover:bg-p-pink transition-colors shadow-pixel-sm"
      >
        [ RETURN ]
      </button>
    </div>
  </div>
</section>

<style>
  .typewriter {
    overflow: hidden;
    border-right: 0.15em solid orange;
    white-space: nowrap;
    margin: 0 auto;
    animation:
      typing 3.5s steps(40, end),
      blink-caret 0.75s step-end infinite;
  }
  @keyframes typing {
    from {
      width: 0;
    }
    to {
      width: 100%;
    }
  }
  @keyframes blink-caret {
    from,
    to {
      border-color: transparent;
    }
    50% {
      border-color: #ff8e72;
    }
  }

  .modal-active #modal-box {
    transform: scale(100%);
    opacity: 1;
  }
</style>

<script>
  (() => {
    const form = document.getElementById("contact-form") as HTMLFormElement;
    const submitBtn = document.getElementById(
      "submit-btn"
    ) as HTMLButtonElement;
    const btnText = document.getElementById("btn-text");
    const btnIcon = document.getElementById("btn-icon");
    const errorMsg = document.getElementById("form-error");

    const modal = document.getElementById("success-modal");
    const modalBox = document.getElementById("modal-box");
    const closeBtn = document.getElementById("close-modal");

    const toggleModal = (show: boolean) => {
      if (show) {
        modal?.classList.remove("hidden");
        setTimeout(() => modal?.classList.add("modal-active"), 10);
      } else {
        modal?.classList.remove("modal-active");
        setTimeout(() => modal?.classList.add("hidden"), 200);
      }
    };

    if (form) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault(); // STOP page reload

        if (submitBtn) {
          submitBtn.disabled = true;
          if (btnText) btnText.textContent = "Sending...";
          if (btnIcon) btnIcon.textContent = "⏳";
        }
        if (errorMsg) errorMsg.classList.add("hidden");

        const formData = new FormData(form);
        const action = form.action;

        try {
          const response = await fetch(action, {
            method: "POST",
            body: formData,
            headers: {
              Accept: "application/json",
            },
          });

          if (response.ok) {
            form.reset();
            toggleModal(true);
          } else {
            const data = await response.json();
            if (Object.hasOwn(data, "errors")) {
              throw new Error(
                data["errors"].map((error: any) => error["message"]).join(", ")
              );
            } else {
              throw new Error("Formspree system failure.");
            }
          }
        } catch (error: any) {
          if (errorMsg) {
            errorMsg.textContent = "Error: " + error.message;
            errorMsg.classList.remove("hidden");
          }
        } finally {
          if (submitBtn) {
            submitBtn.disabled = false;
            if (btnText) btnText.textContent = "Send Letter";
            if (btnIcon) btnIcon.textContent = "✉";
          }
        }
      });
    }

    if (closeBtn) {
      closeBtn.addEventListener("click", () => toggleModal(false));
    }

    if (modal) {
      modal.addEventListener("click", (e) => {
        if (e.target === modal) toggleModal(false);
      });
    }
  })();
</script>
